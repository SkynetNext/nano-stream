# Aeron åœ¨é‡‘èé¢†åŸŸçš„æ ¸å¿ƒä¼˜åŠ¿

## æ¦‚è¿°

Aeron æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„é€šä¿¡åº“ï¼Œç‰¹åˆ«é€‚åˆé‡‘èåº”ç”¨åœºæ™¯ã€‚æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æ Aeron åœ¨é‡‘èé¢†åŸŸå–å¾—æˆåŠŸçš„å…³é”®æŠ€æœ¯ç‰¹æ€§ã€‚

## ğŸ¦ é‡‘èè¡Œä¸šçš„æ ¸å¿ƒéœ€æ±‚

### 1. æä½å»¶è¿Ÿè¦æ±‚
- **é«˜é¢‘äº¤æ˜“ (HFT)** éœ€è¦å¾®ç§’çº§å“åº”
- **åšå¸‚å•†** éœ€è¦å¿«é€ŸæŠ¥ä»·å’Œæˆäº¤
- **é£é™©æ§åˆ¶** éœ€è¦å®æ—¶ç›‘æ§å’Œæ­¢æŸ

### 2. é«˜ååé‡éœ€æ±‚
- **è®¢å•æµ** æ¯ç§’å¤„ç†æ•°ä¸‡åˆ°æ•°åä¸‡è®¢å•
- **å¸‚åœºæ•°æ®** å®æ—¶å¤„ç†å¤§é‡è¡Œæƒ…æ•°æ®
- **æ¸…ç®—ç³»ç»Ÿ** å¤„ç†å¤§é‡äº¤æ˜“è®°å½•

### 3. é«˜å¯é æ€§è¦æ±‚
- **æ•°æ®å®Œæ•´æ€§** ä¸èƒ½ä¸¢å¤±ä»»ä½•äº¤æ˜“æ•°æ®
- **ç³»ç»Ÿå¯ç”¨æ€§** 7x24 å°æ—¶ç¨³å®šè¿è¡Œ
- **æ•…éšœæ¢å¤** å¿«é€Ÿä»æ•…éšœä¸­æ¢å¤

## ğŸš€ Aeron çš„æ ¸å¿ƒæŠ€æœ¯ä¼˜åŠ¿

### 1. å»ä¸­å¿ƒåŒ–æ¶æ„

#### ä¼ ç»Ÿ Client-Server æ¶æ„çš„é—®é¢˜
```
Client â†’ Server â†’ Client
     â†‘              â†“
  è¯·æ±‚          å“åº”
```
- **å•ç‚¹æ•…éšœ**ï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡ä¸­å¤®æœåŠ¡å™¨
- **æ‰©å±•å›°éš¾**ï¼šéœ€è¦å¤æ‚çš„è´Ÿè½½å‡è¡¡å’Œé›†ç¾¤ç®¡ç†

#### Aeron çš„å»ä¸­å¿ƒåŒ–è®¾è®¡
```
Client A â†â†’ Media Driver â†â†’ Client B
     â†‘                        â†“
  å‘å¸ƒ                    è®¢é˜…
```
- **æ— å•ç‚¹æ•…éšœ**ï¼šæ²¡æœ‰ä¸­å¤®æœåŠ¡å™¨
- **æ°´å¹³æ‰©å±•**ï¼šå¯ä»¥æ·»åŠ ä»»æ„æ•°é‡çš„ client
- **å¯¹ç­‰é€šä¿¡**ï¼šclient ä¹‹é—´ç›´æ¥é€šä¿¡

### 2. é›¶æ‹·è´æ¶æ„

#### ä¼ ç»Ÿç½‘ç»œé€šä¿¡çš„æ•°æ®æµ
```cpp
// ä¼ ç»Ÿæ–¹å¼ï¼šå¤šæ¬¡æ•°æ®å¤åˆ¶
class TraditionalNetwork {
    void send_message(const Message &msg) {
        // 1. åºåˆ—åŒ–ï¼šå¯¹è±¡ â†’ å­—èŠ‚æ•°ç»„
        auto data = serialize(msg);                    // å¤åˆ¶ 1
        
        // 2. å‘é€ï¼šç”¨æˆ·ç©ºé—´ â†’ å†…æ ¸ç©ºé—´
        socket.send(data);                             // å¤åˆ¶ 2
        
        // 3. ç½‘ç»œä¼ è¾“ï¼šå†…æ ¸ â†’ ç½‘å¡
        // 4. æ¥æ”¶ï¼šç½‘å¡ â†’ å†…æ ¸ç©ºé—´
        auto received = socket.receive();              // å¤åˆ¶ 3
        
        // 5. ååºåˆ—åŒ–ï¼šå­—èŠ‚æ•°ç»„ â†’ å¯¹è±¡
        auto msg = deserialize(received);              // å¤åˆ¶ 4
    }
};
```

#### Aeron çš„é›¶æ‹·è´è®¾è®¡
```cpp
// Aeron æ–¹å¼ï¼šç›´æ¥å†…å­˜è®¿é—®
class AeronPublication {
    PublicationResult offer(const std::uint8_t *buffer, std::size_t length) {
        // ç›´æ¥å†™å…¥å…±äº«å†…å­˜ï¼Œæ— éœ€æ•°æ®å¤åˆ¶
        return write_to_log_buffer(buffer, length);    // é›¶æ‹·è´
    }
};
```

**æ€§èƒ½æå‡**ï¼š
- **å»¶è¿Ÿé™ä½**ï¼šä» 100Î¼s é™ä½åˆ° 1-10Î¼s
- **ååé‡æå‡**ï¼šä» 10K msg/s æå‡åˆ° 1M+ msg/s
- **CPU ä½¿ç”¨ç‡é™ä½**ï¼šå‡å°‘ 80% çš„ CPU å¼€é”€

### 3. å†…å­˜æ˜ å°„æ–‡ä»¶

#### æŒä¹…åŒ–å­˜å‚¨çš„ä¼˜åŠ¿
```cpp
class MemoryMappedFile {
    // è·¨å¹³å°å†…å­˜æ˜ å°„
    MemoryMappedFile(const std::string &filename, std::size_t size) {
#ifdef _WIN32
        // Windows: CreateFileMapping + MapViewOfFile
        file_handle_ = CreateFileA(filename.c_str(), ...);
        mapping_handle_ = CreateFileMappingA(file_handle_, ...);
        memory_ = MapViewOfFile(mapping_handle_, ...);
#else
        // Linux: mmap
        file_descriptor_ = open(filename.c_str(), O_RDWR | O_CREAT, 0644);
        memory_ = mmap(nullptr, size, PROT_READ | PROT_WRITE, 
                      MAP_SHARED, file_descriptor_, 0);
#endif
    }
};
```

**å…³é”®ç‰¹æ€§**ï¼š
- **æŒä¹…åŒ–**ï¼šæ•°æ®å†™å…¥ç£ç›˜ï¼Œç³»ç»Ÿé‡å¯ä¸ä¸¢å¤±
- **é«˜æ€§èƒ½**ï¼šç»•è¿‡æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œç›´æ¥è®¿é—®å†…å­˜
- **å…±äº«è®¿é—®**ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€æ•°æ®
- **é›¶æ‹·è´**ï¼šæ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶æ•°æ®

### 4. æ— é”è®¾è®¡

#### åŸºäºåºåˆ—å·çš„æ— é”æ“ä½œ
```cpp
class RingBuffer {
    std::atomic<std::int64_t> next_sequence_{0};
    
    // å•ç”Ÿäº§è€…ä¼˜åŒ–
    std::int64_t next_single_producer() {
        return next_sequence_++; // ç›´æ¥èµ‹å€¼ï¼Œæ— é”
    }
    
    // å¤šç”Ÿäº§è€…æ”¯æŒ
    std::int64_t next_multi_producer() {
        return next_sequence_.fetch_add(1); // åŸå­æ“ä½œ
    }
};
```

**æ€§èƒ½ä¼˜åŠ¿**ï¼š
- **æ— é”ç«äº‰**ï¼šé¿å…çº¿ç¨‹ç«äº‰å’Œé”å¼€é”€
- **ç¼“å­˜å‹å¥½**ï¼šæ•°æ®å±€éƒ¨æ€§ä¼˜åŒ–
- **çº¿æ€§æ‰©å±•**ï¼šæ€§èƒ½éš CPU æ ¸å¿ƒæ•°çº¿æ€§å¢é•¿

### 5. å‘å¸ƒ/è®¢é˜…æ¨¡å¼

#### çµæ´»çš„æ¶ˆæ¯åˆ†å‘
```cpp
// å¤šä¸ªå‘å¸ƒè€…
auto pub1 = aeron->add_publication("aeron:udp?endpoint=localhost:40456", 1001);
auto pub2 = aeron->add_publication("aeron:udp?endpoint=localhost:40456", 1001);

// å¤šä¸ªè®¢é˜…è€…
auto sub1 = aeron->add_subscription("aeron:udp?endpoint=localhost:40456", 1001);
auto sub2 = aeron->add_subscription("aeron:udp?endpoint=localhost:40456", 1001);
auto sub3 = aeron->add_subscription("aeron:udp?endpoint=localhost:40456", 1001);
```

**åº”ç”¨åœºæ™¯**ï¼š
- **ä¸€å¯¹å¤š**ï¼šä¸€ä¸ªå‘å¸ƒè€…ï¼Œå¤šä¸ªè®¢é˜…è€…
- **å¤šå¯¹å¤š**ï¼šå¤šä¸ªå‘å¸ƒè€…ï¼Œå¤šä¸ªè®¢é˜…è€…
- **åŠ¨æ€**ï¼šè¿è¡Œæ—¶æ·»åŠ /ç§»é™¤å‚ä¸è€…

## ğŸ’° é‡‘èåº”ç”¨åœºæ™¯

### 1. äº¤æ˜“ç³»ç»Ÿæ¶æ„
```
è®¢å•ç®¡ç† â†’ Aeron â†’ æ‰§è¡Œå¼•æ“
é£é™©æ§åˆ¶ â†’ Aeron â†’ é£æ§å¼•æ“
æ¸…ç®—ç³»ç»Ÿ â†’ Aeron â†’ ç»“ç®—å¼•æ“
```

### 2. å¸‚åœºæ•°æ®åˆ†å‘
```
äº¤æ˜“æ‰€ â†’ Aeron â†’ åšå¸‚å•† A
       â†’ Aeron â†’ åšå¸‚å•† B
       â†’ Aeron â†’ åšå¸‚å•† C
       â†’ Aeron â†’ ç®—æ³•äº¤æ˜“
       â†’ Aeron â†’ é£é™©ç›‘æ§
```

### 3. å¾®æœåŠ¡é€šä¿¡
```
è®¢å•æœåŠ¡ â†’ Aeron â†’ æ‰§è¡ŒæœåŠ¡
         â†’ Aeron â†’ é£æ§æœåŠ¡
         â†’ Aeron â†’ é€šçŸ¥æœåŠ¡

ç”¨æˆ·æœåŠ¡ â†’ Aeron â†’ è®¢å•æœåŠ¡
         â†’ Aeron â†’ é€šçŸ¥æœåŠ¡
```

## ğŸ”§ å¯é æ€§æœºåˆ¶

### 1. æŒä¹…åŒ–æ—¥å¿—
```cpp
class LogBuffer {
    struct LogHeader {
        std::int64_t term_id;
        std::int64_t sequence_number;
        std::int32_t message_length;
        std::uint8_t message_data[];
    };
    
    void append_message(const std::uint8_t *data, std::size_t length) {
        // 1. åˆ†é…ç©ºé—´
        auto position = allocate_space(length + sizeof(LogHeader));
        
        // 2. å†™å…¥å¤´éƒ¨
        LogHeader header{term_id_, next_sequence_, length};
        write_header(position, header);
        
        // 3. å†™å…¥æ•°æ®
        write_data(position + sizeof(LogHeader), data, length);
        
        // 4. åŒæ­¥åˆ°ç£ç›˜
        sync_to_disk();
    }
};
```

### 2. åºåˆ—å·ç®¡ç†
```cpp
class SequenceManager {
    std::atomic<std::int64_t> next_sequence_{0};
    
    std::int64_t next_sequence() {
        return next_sequence_.fetch_add(1);
    }
    
    bool is_sequence_valid(std::int64_t sequence) {
        return sequence >= 0 && sequence < next_sequence_.load();
    }
};
```

### 3. æµæ§åˆ¶
```cpp
class FlowControl {
    std::atomic<std::int64_t> receiver_position_{0};
    std::atomic<std::int64_t> sender_position_{0};
    
    bool can_send(std::int64_t position) {
        // æ£€æŸ¥æ¥æ”¶æ–¹æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´
        return position < receiver_position_.load() + window_size_;
    }
};
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### 1. å»¶è¿Ÿå¯¹æ¯”
| æŠ€æœ¯ | å…¸å‹å»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|
| TCP Socket | 10-100Î¼s | ä¸€èˆ¬åº”ç”¨ |
| Aeron | 1-10Î¼s | é«˜é¢‘äº¤æ˜“ |
| å†…æ ¸æ—è·¯ | <1Î¼s | æä½å»¶è¿Ÿ |

### 2. ååé‡å¯¹æ¯”
| æŠ€æœ¯ | æ¶ˆæ¯/ç§’ | æ•°æ®é‡ |
|------|---------|--------|
| ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ— | 10K-100K | å°åˆ°ä¸­ç­‰ |
| Aeron | 1M-10M | é«˜ååé‡ |
| ä¼˜åŒ–é…ç½® | 10M+ | æé«˜ååé‡ |

### 3. å¯é æ€§å¯¹æ¯”
| æŠ€æœ¯ | å¯é æ€§ | è¯´æ˜ |
|------|--------|------|
| å¯é UDP | ç½‘ç»œçº§åˆ« | ä¾èµ–ç½‘ç»œè¿æ¥ |
| Aeron | åº”ç”¨çº§åˆ« | æŒä¹…åŒ–å­˜å‚¨ |

## ğŸ¯ ç£ç›˜å†™å…¥ä¼˜åŒ–

### 1. ç†è®ºåŸºç¡€
ç°ä»£ç¡¬ä»¶æ€§èƒ½å¯¹æ¯”ï¼š
- **å†…å­˜è®¿é—®**: ~100ns
- **NVMe SSD**: ~10-100Î¼s  
- **ç½‘ç»œå¾€è¿”**: ~100-1000Î¼s

**ç»“è®º**: ç£ç›˜å†™å…¥æ¯”ç½‘ç»œä¼ è¾“å¿« 10-100 å€

### 2. Aeron çš„å·§å¦™è®¾è®¡
```cpp
class AeronFlushStrategy {
    void handle_message(const std::uint8_t *data, std::size_t length) {
        // 1. å†™å…¥å†…å­˜æ˜ å°„æ–‡ä»¶ï¼ˆåœ¨å†…å­˜ä¸­ï¼‰
        log_buffer_.append(data, length);
        
        // 2. å¼‚æ­¥ flushï¼ˆä¸æ˜¯ç«‹å³ï¼‰
        schedule_async_flush();
        
        // 3. ç«‹å³è¿”å›ï¼ˆå¾®ç§’çº§å»¶è¿Ÿï¼‰
        return PublicationResult::SUCCESS;
    }
};
```

**å…³é”®ç‰¹æ€§**ï¼š
- **ä¸æ˜¯æ¯æ¡æ¶ˆæ¯éƒ½ç«‹å³ flush**ï¼šåˆ©ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶çš„ç‰¹æ€§
- **æ“ä½œç³»ç»Ÿè‡ªåŠ¨ç®¡ç†**ï¼šè„é¡µå¼‚æ­¥å†™å…¥ç£ç›˜
- **å¯é…ç½®çš„ flush ç­–ç•¥**ï¼šæ ¹æ®åº”ç”¨éœ€æ±‚é€‰æ‹©
- **æ€§èƒ½ä¸å¯é æ€§å¹³è¡¡**ï¼šåœ¨ä¿è¯å¯é æ€§çš„å‰æä¸‹æœ€å¤§åŒ–æ€§èƒ½

## ğŸ”§ æˆ‘ä»¬çš„ C++ å®ç°

### 1. æ ¸å¿ƒç»„ä»¶
```cpp
// å†…å­˜æ˜ å°„æ–‡ä»¶
class MemoryMappedFile {
    // è·¨å¹³å°å®ç°
    // Windows: CreateFileMapping + MapViewOfFile
    // Linux: mmap
};

// æ— é”ç¯å½¢ç¼“å†²åŒº
template<typename T>
class RingBuffer {
    // åŸºäº nano-stream å®ç°
    // æ”¯æŒå•ç”Ÿäº§è€…å’Œå¤šç”Ÿäº§è€…
};

// åºåˆ—å·ç®¡ç†
class Sequence {
    std::atomic<std::int64_t> value_{INITIAL_VALUE};
    // å†…å­˜å±éšœä¼˜åŒ–
    // ç¼“å­˜è¡Œå¯¹é½
};
```

### 2. æ€§èƒ½ç‰¹æ€§
- **å»¶è¿Ÿä¼˜åŒ–**: å†…å­˜è®¿é—® < 1Î¼sï¼Œæ— é”æ“ä½œ < 100ns
- **ååé‡ä¼˜åŒ–**: é›¶æ‹·è´ï¼Œé¢„åˆ†é…ï¼Œç¼“å­˜å‹å¥½
- **å¯æ‰©å±•æ€§**: å¤šçº¿ç¨‹çº¿æ€§æ‰©å±•ï¼Œå¤šè¿›ç¨‹å…±äº«å†…å­˜

## æ€»ç»“

Aeron åœ¨é‡‘èé¢†åŸŸæˆåŠŸçš„å…³é”®å› ç´ ï¼š

### 1. æŠ€æœ¯ä¼˜åŠ¿
- **æä½å»¶è¿Ÿ**: å†…å­˜æ“ä½œ vs ç½‘ç»œå¾€è¿”
- **é«˜ååé‡**: é›¶æ‹·è´ vs å¤šæ¬¡æ•°æ®å¤åˆ¶
- **é«˜å¯é æ€§**: æŒä¹…åŒ–å­˜å‚¨ vs ç½‘ç»œä¾èµ–
- **é«˜æ‰©å±•æ€§**: æ°´å¹³æ‰©å±• vs å‚ç›´æ‰©å±•

### 2. æ¶æ„ä¼˜åŠ¿
- **å»ä¸­å¿ƒåŒ–**: é¿å…å•ç‚¹æ•…éšœ
- **å‘å¸ƒ/è®¢é˜…**: çµæ´»çš„æ¶ˆæ¯åˆ†å‘
- **æ— é”è®¾è®¡**: çº¿æ€§æ€§èƒ½æ‰©å±•
- **è·¨å¹³å°**: Windows/Linux å…¼å®¹

### 3. åº”ç”¨ä¼˜åŠ¿
- **ç®€å•éƒ¨ç½²**: åªéœ€è¦å¯åŠ¨ Media Driver
- **æˆç†Ÿç¨³å®š**: ç”Ÿäº§ç¯å¢ƒéªŒè¯
- **å¼€æºç”Ÿæ€**: æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ
- **è¯­è¨€æ”¯æŒ**: Javaã€C++ã€.NETã€Go

Aeron ä¸ºé‡‘èåº”ç”¨æä¾›äº†ä¸€ä¸ªé«˜æ€§èƒ½ã€ä½å»¶è¿Ÿã€é«˜å¯é çš„é€šä¿¡åŸºç¡€è®¾æ–½ï¼Œèƒ½å¤Ÿæ»¡è¶³ç°ä»£é‡‘èç³»ç»Ÿå¯¹å®æ—¶æ€§å’Œå¯é æ€§çš„ä¸¥æ ¼è¦æ±‚ã€‚æˆ‘ä»¬çš„ C++ å®ç°è¿›ä¸€æ­¥æ‰©å±•äº† Aeron çš„åº”ç”¨èŒƒå›´ï¼Œä¸º C++ å¼€å‘è€…æä¾›äº†åŒæ ·çš„é«˜æ€§èƒ½é€šä¿¡èƒ½åŠ›ã€‚
